<!DOCTYPE html>
<html>

<head>
	<title>T40 FX Module</title>
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Rubik">
	<link rel="stylesheet" href="style.css">
	<script src="bundle.js"></script>
	<script src="term.js"></script>

</head>

<body>
	<div class="terminal-settings">
		Serial port speed:
		<select name="speed" id="SerialSpeed">
			<option value="115200">115200</option>
			<option value="1200">1200</option>
			<option value="2400">2400</option>
			<option value="4800">4800</option>
			<option value="9600">9600</option>
			<option value="19200">19200</option>
			<option value="38400">38400</option>
			<option value="57600">57600</option>
			<option value="115200">115200</option>
		</select>
		<button id="SerialConnectButton" type="button" disabled>Connect</button>
		Powered by <a href="https://github.com/benc-uk/touchmidi" target="_blank">TouchMIDI</a> and <a
			href="https://github.com/rafaelaroca/web-serial-terminal" target="_blank">web-serial-terminal</a>. 
			<strong>T40 FX Module  </strong>
			<a href="https://www.hexefx.com" target="_blank">www.hexefx.com</a> Version: 1.0
	</div>
	<div class="layout">

		<!-- Main TAB -->
		<input name="nav" type="radio" class="main-radio" id="main" checked="checked" />
		<div class="page main-page">
			<div class="page-contents">
				<div class="controls controls-main">
					<group-row>
						<midi-spacer></midi-spacer>	
					<group-column>
						<midi-encoder label="Dly/Rvb\nMix\n%p" chan="1" cc="50" colour="#B3E5FC" label-scale="0.8"></midi-encoder>
						<midi-encoder label="Dry/Wet\nMix\n%p" chan="1" cc="51" colour="#B3E5FC" label-scale="0.8"></midi-encoder>
						<midi-encoder label="Phaser\nMix\n%p" chan="1" cc="45" colour="#B3E5FC" label-scale="0.8"></midi-encoder>
					</group-column>
					<midi-spacer></midi-spacer>	
					</group-row>
				</div>
			</div>
			<div>
				<img src="signalPath.png"  />
			</div>
		</div>
		<label class="nav" for="main">Main</label>		

		<!-- REVERB TAB -->
		<input name="nav" type="radio" class="reverb-radio" id="reverb"  />
		<div class="page reverb-page">
			<div class="page-contents">
				<div class="controls">
					<group-row>
						<midi-button toggle note="4" colour="#B3E5FC" label="On/Off" label-scale="0.8"></midi-button>
						<midi-encoder label="Time\n%p" chan="1" cc="20" colour="#FFF9C4" label-scale="0.8"></midi-encoder>
						<midi-encoder label="Diffusion\n%p" chan="1" cc="21" colour="#FFF9C4" label-scale="0.8"></midi-encoder>
						<midi-encoder label="TrebleCut\n%p" chan="1" cc="24" colour="#FFF9C4" label-scale="0.8"></midi-encoder>
						<midi-encoder label="BassCut\n%p" chan="1" cc="23" colour="#FFF9C4" label-scale="0.8"></midi-encoder>
						<midi-encoder label="Treble\n%p" chan="1" cc="26" colour="#FFF9C4" label-scale="0.8"></midi-encoder>
						<midi-encoder label="Bass\n%p" chan="1" cc="25" colour="#FFF9C4" label-scale="0.8"></midi-encoder>
									
					</group-row>
					<group-row>
						<midi-button toggle note="5" colour="#B3E5FC" label="Freeze" label-scale="0.8"></midi-button>
						<midi-encoder label="BleedIn\n%p" chan="1" cc="27" colour="#FFF9C4" label-scale="0.8"></midi-encoder>
						<midi-encoder label="Pitch\n%p" chan="1" cc="28" colour="#FFF9C4" label-scale="0.8"></midi-encoder>
						<midi-encoder label="PitchMix\n%p" chan="1" cc="29" colour="#FFF9C4" label-scale="0.8"></midi-encoder>
						<midi-encoder label="Shimmer\n%p" chan="1" cc="30" colour="#FFF9C4" label-scale="0.8"></midi-encoder>
						<midi-encoder label="PitchShim\n%p" chan="1" cc="31" colour="#FFF9C4" label-scale="0.8"></midi-encoder>
						<midi-spacer></midi-spacer>	
					</group-row>
				</div>
			</div>	
		</div>
		<label class="nav" for="reverb">Reverb</label>		
		<!-- DELAY TAB -->
		<input name="nav" type="radio" class="delay-radio" id="delay" />
		<div class="page delay-page">
			<div class="page-contents">
				<div class="controls">
					<group-row>
						<midi-button toggle note="1" colour="#B3E5FC" label="On/Off" label-scale="0.8"></midi-button>
						<midi-encoder label="Time\n%p" chan="1" cc="1" colour="#B3E5FC" label-scale="0.8"></midi-encoder>
						<midi-encoder label="Inertia\n%p" chan="1" cc="2" colour="#B3E5FC" label-scale="0.8"></midi-encoder>
						<midi-encoder label="Repeats\n%p" chan="1" cc="3" colour="#B3E5FC" label-scale="0.8"></midi-encoder>	
						<midi-encoder label="Mod\nRate\n%p" chan="1" cc="5" colour="#d082d9" label-scale="0.8"></midi-encoder>
						<midi-encoder label="Mod\nDepth\n%p" chan="1" cc="6" colour="#d082d9" label-scale="0.8"></midi-encoder>
						<midi-button note="2" colour="#B3E5FC" label="Tap" label-scale="0.8"></midi-button>
					</group-row>
					<group-row>
						<midi-spacer></midi-spacer>
						<midi-encoder label="HiCut\n%p" chan="1" cc="7" colour="#bad9b2" label-scale="0.8"></midi-encoder>
						<midi-encoder label="LowCut\n%p" chan="1" cc="8" colour="#bad9b2" label-scale="0.8"></midi-encoder>
						<midi-button toggle note="3" colour="#B3E5FC" label="Freeze" label-scale="0.8"></midi-button>
						<midi-encoder label="Treble\n%p" chan="1" cc="9" colour="#bad9b2" label-scale="0.8"></midi-encoder>
						<midi-encoder label="Bass\n%p" chan="1" cc="10" colour="#bad9b2" label-scale="0.8"></midi-encoder>		
						<midi-spacer></midi-spacer>
					</group-row>
				</div>
			</div>
		</div>
		<label class="nav" for="delay">Delay</label>
		<!-- PHASER TAB -->
		<input name="nav" type="radio" class="delay-radio" id="phaser" />
		<div class="page phaser-page">
			<div class="page-contents">
				<div class="controls">
					<group-row>
						<midi-button toggle note="6" colour="#B3E5FC" label="On/Off" label-scale="0.8"></midi-button>
						<midi-encoder label="Depth\nTop\n%p" chan="1" cc="40" colour="#B3E5FC" label-scale="0.8"></midi-encoder>
						<midi-encoder label="Depth\nBtm\n%p" chan="1" cc="41" colour="#B3E5FC" label-scale="0.8"></midi-encoder>
						<midi-encoder label="Rate\n%p" chan="1" cc="42" colour="#B3E5FC" label-scale="0.8"></midi-encoder>	
						<midi-encoder label="Feedback\n%p" chan="1" cc="44" colour="#d082d9" label-scale="0.8"></midi-encoder>
						<midi-encoder label="Stereo\n%p" chan="1" cc="43" colour="#d082d9" label-scale="0.8"></midi-encoder>
						<midi-encoder label="Stages\n%p" chan="1" cc="46" colour="#d082d9" label-scale="0.8"></midi-encoder>
					</group-row>
				</div>
			</div>
		</div>
		<label class="nav" for="phaser">Phaser</label>
	</div>
	<div class="term-wrapper">
		<div id="term"></div>
	</div>
</body>
<script>
	var term;
	function calculate_size(win) {
		var cols = Math.max(80, Math.min(80, (win.innerWidth - 280) / 7)) | 0;
		var rows = Math.max(8, Math.min(8, (win.innerHeight - 180) / 12)) | 0;
		return [cols, rows];
	}
	(function () {
		window.onload = function () {

			var size = calculate_size(self);
			term = new Terminal({
				cols: 80,
				rows: 8,
				useStyle: false,
				screenKeys: true,
				cursorBlink: false
			});
			term.innerText
			term.open(document.getElementById("term"));
		};
		window.addEventListener('resize', function () {
			var size = calculate_size(self);
			term.resize(size[0], size[1]);
		});
	}).call(this);
	/*
	* Web Serial API (Google Chrome)
	*
	* Useful information used to this implementation:
	* https://github.com/svendahlstrand/web-serial-api/
	* https://dev.to/unjavascripter/the-amazing-powers-of-the-web-web-serial-api-3ilc
	*
	*/
	const connectButton = document.getElementById('SerialConnectButton');
	let port;

	if ('serial' in navigator) {
		connectButton.addEventListener('click', function () {
			if (port) {
				term.write('\x1b[31mDisconnected from Serial Port\x1b[m\r\n');
				port.close();
				port = undefined;
				connectButton.innerText = 'Connect';
				document.getElementById('SerialSpeed').disabled = false;
			}
			else {
				connectButton.innerText = 'Disconnect';
				getReader();
			}
		});
		connectButton.disabled = false;
	}
	else {
		const error = document.createElement('p');
		error.innerHTML = '<p>Support for Serial Web API not enabled. Please enable it using chrome://flags/ and enable Experimental Web Platform fetures</p>';
	}
	let lineBuffer = '';
	let latestValue = 0;
	async function serialWrite(data) {
		encoder = new TextEncoder();
		const dataArrayBuffer = encoder.encode(data);

		if (port && port.writable) {
			const writer = port.writable.getWriter();
			writer.write(dataArrayBuffer);
			writer.releaseLock();
		}
	}
	async function getReader() {
		port = await navigator.serial.requestPort({});
		var e = document.getElementById("SerialSpeed");
		var strSpd = e.options[e.selectedIndex].value;

		var speed = parseInt(strSpd);
		await port.open({ baudRate: [speed] });
		document.getElementById('SerialSpeed').disabled = true;
		connectButton.innerText = 'Disconnect';
		const appendStream = new WritableStream({
			write(chunk) {
				term.write(chunk);
			}
		});
		port.readable
			.pipeThrough(new TextDecoderStream())
			.pipeTo(appendStream);
		term.on('data', function (data) {
			serialWrite(data);
		});
	}
</script>
</html>